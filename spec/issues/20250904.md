# 2025-09-04 开发任务清单

## 概述

基于 MVP 规格文档，制定 8 个可并行开发的独立任务，避免代码冲突，让团队成员能够高效协作推进项目。

## 任务列表

### 1. CLI - 实现 uspark push 命令

**负责模块**: `turbo/apps/cli`

**任务描述**:
- 实现本地文件上传到 YJS 存储的功能
- 支持单个文件推送：`uspark push <file-path> --project-id <id>`
- 支持批量推送：`uspark push --all --project-id <id>`
- 使用环境变量 `USPARK_TOKEN` 进行认证

**验收标准**:
- [ ] 单文件推送功能正常工作
- [ ] --all 参数能批量推送所有修改的文件
- [ ] 正确处理文件不存在和权限错误
- [ ] 推送成功后显示上传的文件列表

**相关文档**: `spec/issues/mvp.md` (Story 1)

---

### 2. Web UI - 创建 CLI Token 管理页面

**负责模块**: `turbo/apps/web/app/settings/tokens`

**任务描述**:
- 创建 token 生成和管理界面
- 实现生成新 token 的功能
- 显示 token 一次后不再显示（安全考虑）
- 提供复制 token 到剪贴板的功能

**验收标准**:
- [ ] 页面路由 `/settings/tokens` 可访问
- [ ] 能够生成新的 CLI token
- [ ] Token 只显示一次，刷新后不再显示
- [ ] 复制按钮正常工作并有反馈提示

**相关文档**: `spec/issues/cli-auth.md`

---

### 3. Backend - 项目管理 APIs ✅

**负责模块**: `turbo/apps/web/app/api/projects`

**任务描述**:
- 实现项目列表获取：`GET /api/projects`
- 实现创建新项目：`POST /api/projects`
- 复用现有的 YJS 同步端点进行文件数据管理
- 客户端解析 YJS snapshot 获取文件结构和内容

**验收标准**:
- [x] 列表 API 返回用户的所有项目
- [x] 创建项目 API 正确初始化 YJS 文档
- [x] 客户端能够从 YJS snapshot 解析文件结构
- [x] 通过现有 YJS 同步机制管理项目数据

**完成情况**:
- ✅ PR #99 已合并：`feat: implement project management apis with client-side file parsing`
- ✅ 实现了 GET /api/projects（列出用户项目）和 POST /api/projects（创建新项目）
- ✅ 添加了 @uspark/core 中的 API contracts 用于类型安全验证
- ✅ 包含 10 个完整的测试用例，覆盖所有功能和错误场景
- ✅ 使用客户端 YJS snapshot 解析方式，避免了不必要的文件 API 端点
- ✅ 所有代码质量检查通过（lint, type check, tests）

**相关文档**: `spec/issues/web-ui.md`

---

### 4. Frontend - 文件浏览器组件 ✅

**负责模块**: `turbo/apps/web/components/file-explorer`

**任务描述**:
- 开发树形文件浏览器 React 组件
- 支持文件夹展开/折叠
- 显示文件图标（区分文件类型）
- 点击文件触发选择事件

**验收标准**:
- [x] 树形结构正确渲染
- [x] 文件夹可以展开和折叠
- [x] 文件图标根据扩展名显示
- [x] 点击事件正确传递文件路径

**完成情况**:
- ✅ PR #107 已合并：`feat: implement file explorer component with YJS integration`
- ✅ 实现了完整的文件浏览器组件，支持 YJS 文档解析
- ✅ 包含树形结构渲染、文件夹展开折叠功能
- ✅ 添加了文件类型图标和点击选择事件
- ✅ 包含完整的测试覆盖，确保组件功能正常

**相关文档**: `spec/issues/web-ui.md`

---

### 5. Backend - 文档分享 APIs ✅

**负责模块**: `turbo/apps/web/app/api/share`

**任务描述**:
- 生成分享链接：`POST /api/share`
- 获取分享内容：`GET /api/share/:token`
- 列出用户分享：`GET /api/share`（延期到下个迭代）
- 撤销分享链接：`DELETE /api/share/:id`（延期到下个迭代）

**验收标准**:
- [x] 生成的 token 是加密安全的随机字符串
- [x] 公开访问端点不需要认证
- [x] 正确记录访问次数和时间（数据库字段已预留）
- [ ] 删除操作正确清理数据（延期到下个迭代）

**完成情况**:
- ✅ PR #101 已合并：`feat: implement document sharing apis with single-file support`
- ✅ 实现了 POST /api/share（创建分享链接）和 GET /api/share/:token（访问分享内容）
- ✅ 在 @uspark/core 中定义了类型安全的 API contracts
- ✅ 使用 crypto.randomBytes(32) 生成加密安全的 token
- ✅ 包含 13 个完整的测试用例，覆盖所有功能和错误场景
- ✅ GET /api/share/:token 返回文件元数据（hash, mtime）供前端直接访问 Blob
- ⚠️ 注意：当前返回文件元数据而非实际内容，等待 Vercel Blob 集成完成

**相关文档**: `spec/issues/document-sharing.md`

---

### 6. CLI - uspark watch-claude 命令 ✅

**负责模块**: `turbo/apps/cli/src/commands`

**任务描述**:
- 实现监听 Claude JSON 输出流的功能
- 检测文件写入事件并触发实时同步
- 保持输出透明传递（不影响原始输出）
- 后台执行 `uspark push` 同步文件

**验收标准**:
- [x] 正确解析 Claude 的 JSON 格式输出
- [x] 检测到文件写入立即触发同步
- [x] 原始输出完整传递不受影响
- [x] 错误处理不中断主流程

**完成情况**:
- ✅ PR #100 已合并：`feat(cli): implement uspark watch-claude command for real-time sync`
- ✅ 实现了完整的 watch-claude 命令，支持实时监控和同步
- ✅ 包含测试用例覆盖各种场景
- ✅ 与 Claude Code 输出格式完美集成

**相关文档**: `spec/issues/e2b-runtime-container.md`

---

### 7. Frontend - 公开文档查看页面

**负责模块**: `turbo/apps/web/app/share/[token]`

**任务描述**:
- 创建无需认证的公开查看页面
- 实现只读文档查看器（支持语法高亮）
- 项目分享时显示文件树
- 响应式设计支持移动端

**验收标准**:
- [ ] 路由 `/share/:token` 可公开访问
- [ ] 文档内容正确显示并有语法高亮
- [ ] 项目分享显示完整文件树
- [ ] 移动端布局正常显示

**相关文档**: `spec/issues/document-sharing.md`

---

### 8. Database - 数据库表结构设置 ✅

**负责模块**: `turbo/apps/web/src/db/migrations`

**任务描述**:
- 创建 `agent_sessions` 表存储 Agent 执行会话（原 claude_tasks）
- 创建 `share_links` 表存储分享链接
- 设置必要的索引优化查询性能
- 添加外键约束确保数据完整性

**验收标准**:
- [x] 迁移脚本可以正常执行
- [x] 表结构符合规格文档定义
- [x] 索引正确创建（token, project_id 等）
- [x] 外键约束正确设置

**完成情况**: 
- ✅ PR #102 已合并：`feat: add agent_sessions and share_links database tables`
- ✅ 创建了 `0004_agent_sessions_share_links.sql` 迁移文件
- ✅ 添加了 Drizzle schema 定义：`agent-sessions.ts`, `share-links.ts`
- ✅ 包含完整的外键约束和性能优化索引

**相关文档**: 
- `spec/issues/web-ui.md` (claude_tasks 表)
- `spec/issues/document-sharing.md` (share_links 表)

---

### 9. Backend - Vercel Blob 集成

**负责模块**: `turbo/apps/web/src/lib/blob-store`

**任务描述**:
- 集成 Vercel Blob 存储用于文件内容存储和检索
- 实现 BlobStore 接口以支持基于 hash 的文件访问
- 更新文档分享 API 以正确返回文件内容
- 确保与现有 YJS 文件系统架构兼容

**验收标准**:
- [ ] 实现 BlobStore 接口连接 Vercel Blob 服务
- [ ] 支持通过文件 hash 存储和检索内容
- [ ] GET /api/share/:token 返回实际文件内容而非元数据
- [ ] 与 YJS FileSystem 架构正确集成

**相关文档**: `spec/issues/document-sharing.md`

**依赖**: 任务 5 (文档分享 APIs) - 当前返回文件元数据（hash, mtime）等待 Blob 集成

---

## 并行开发策略

这 9 个任务分布在不同的代码区域，可以实现真正的并行开发：

1. **CLI 包任务** (任务 1, 6): 两个不同的命令，互不干扰
2. **Web 前端任务** (任务 2, 4, 7): 三个独立的页面/组件
3. **API 后端任务** (任务 3, 5, 9): 三组不同的 API 端点和存储集成
4. **数据库任务** (任务 8): 独立的数据库层面工作

## 注意事项

- 每个任务开始前先从 main 分支创建独立的功能分支
- 遵循项目的 commit message 规范（conventional commits）
- 完成后运行 lint 和 type check 确保代码质量
- 及时更新任务状态，方便团队了解进度

## 依赖关系

大部分任务相互独立，但存在以下软依赖：
- 任务 2 (Token 管理页面) 依赖已有的 token 生成 API（已完成）
- 任务 7 (公开查看页) 最好在任务 5 (分享 API) 之后测试
- 任务 9 (Vercel Blob 集成) 依赖任务 5 (分享 API) - 需要修复文件内容返回功能
- 其他任务完全独立，可立即开始

## 预期成果

完成这 9 个任务后，将实现 MVP 的核心功能：
- 🔄 完整的 CLI 同步功能（push 待实现，watch-claude 已完成）
- 🔄 Web UI 项目管理和文件浏览（项目管理 API 已完成）
- ✅ 文档分享功能（API 已完成，前端展示页待实现）
- ✅ Claude Code 集成准备
- ✅ 必要的数据库基础设施

## 已完成任务统计

- **已完成**: 7/9 任务
  - ✅ 任务 2: Web UI - 创建 CLI Token 管理页面 (PR #103)
  - ✅ 任务 3: Backend - 项目管理 APIs (PR #99)
  - ✅ 任务 4: Frontend - 文件浏览器组件 (PR #107)
  - ✅ 任务 5: Backend - 文档分享 APIs (PR #101)
  - ✅ 任务 6: CLI - uspark watch-claude 命令 (PR #100)
  - ✅ 任务 7: Frontend - 公开文档查看页面 (PR #106)
  - ✅ 任务 8: Database - 数据库表结构设置 (PR #102)
  
- **进行中**: 2/9 任务
  - 任务 1: CLI - 实现 uspark push 命令 (分支: feat/cli-push-command)
  - 任务 9: Backend - Vercel Blob 集成 (分支: feat/vercel-blob-integration-tests)

---

## 2025-09-04 全天工作总结

### 完成情况

今天团队完成了大量工作，在一天内完成了 6 个主要任务，总体完成率达到 77.8%：

1. **CLI Token 管理页面** - 完整实现，包含生成、显示一次性 token 和复制功能
2. **项目管理 APIs** - 实现了项目列表和创建功能
3. **文件浏览器组件** - 完整的树形文件浏览器，支持 YJS 集成
4. **文档分享 APIs** - 实现了创建分享链接和访问分享内容
5. **CLI watch-claude 命令** - 实现了实时监控和同步功能
6. **公开文档查看页面** - 实现了分享页面的 UI 和基础功能
7. **数据库表结构** - 创建了必要的数据库表和迁移脚本

### 发现的问题

经过详细代码审查，发现以下需要修复的问题：

#### 🚨 严重问题

1. **项目管理 APIs - 硬编码测试用户**
   - 位置: `turbo/apps/web/app/api/projects/route.ts:22, 54`
   - 问题: 使用硬编码的 `userId = "test-user"`，所有项目都会归属于同一个测试用户
   - 影响: **生产环境无法正常使用**
   - 修复建议: 必须集成 Clerk 认证，使用真实的用户 ID

2. **CLI 认证 - 硬编码延迟**
   - 位置: `turbo/apps/cli/src/auth.ts:86`
   - 问题: 硬编码 5 秒延迟 `setTimeout(resolve, 5000)`
   - 影响: 违反项目 YAGNI 原则，影响用户体验
   - 修复建议: 使用服务器返回的 `deviceAuth.interval * 1000`

#### ⚠️ 功能限制

1. **文档分享 APIs - 缺少实际内容**
   - 位置: `turbo/apps/web/app/api/share/[token]/route.ts:88`
   - 问题: 只返回文件的 hash 和 mtime 元数据
   - 影响: 无法显示实际文件内容
   - 依赖: 需要完成 Vercel Blob 集成

2. **公开文档查看页面 - Blob 存储未集成**
   - 位置: `turbo/apps/web/app/share/[token]/page.tsx:44-47`
   - 问题: 使用未配置的 `NEXT_PUBLIC_BLOB_URL` 环境变量
   - 影响: 文件内容无法正常显示
   - 依赖: 需要完成 Vercel Blob 集成和 STS token 认证

### 实际可用性评估

- **完全可用**: 3/9 任务 (33.3%)
  - ✅ CLI Token 管理页面
  - ✅ 文件浏览器组件  
  - ✅ CLI watch-claude 命令

- **部分可用**: 4/9 任务 (44.4%)
  - ⚠️ 项目管理 APIs (需要修复认证)
  - ⚠️ 文档分享 APIs (需要 Blob 集成)
  - ⚠️ 公开文档查看页面 (需要 Blob 集成)
  - ✅ 数据库表结构 (已完成但依赖其他功能)

- **未完成**: 2/9 任务 (22.2%)
  - ❌ CLI push 命令
  - ❌ Vercel Blob 集成

### 优先修复事项

1. **P0 - 立即修复**
   - 项目管理 APIs 的用户认证问题
   - CLI 认证中的硬编码延迟

2. **P1 - 尽快完成**
   - Vercel Blob 集成（解锁文档分享功能）
   - CLI push 命令实现（核心同步功能）

3. **P2 - 后续优化**
   - 公开文档查看页面的测试覆盖
   - 文档分享的 STS token 认证机制

### 团队表现

尽管存在一些问题，今天的开发进度非常出色：
- 6 个任务在一天内完成
- 代码质量整体良好，测试覆盖充分
- 架构设计合理，遵循了大部分项目原则

主要问题集中在认证集成和存储服务集成上，这些都是可以快速修复的问题。建议明天优先处理这些阻塞性问题，确保已完成的功能能够正常使用。

---

## 用户验收测试案例

### 🔐 1. CLI 认证流程

#### 场景：首次使用 CLI 工具
```bash
# 安装并运行 CLI
cd turbo && pnpm install && pnpm build
npx uspark auth status  # 查看当前认证状态

# 登录到 Uspark
npx uspark auth login
# 系统将打开浏览器进行 OAuth 认证
# 认证成功后，CLI 会自动保存 token

# 验证登录状态
npx uspark auth status
# 应显示：已认证，显示用户邮箱

# 退出登录
npx uspark auth logout
```

**预期结果**：
- ✅ 浏览器自动打开认证页面
- ✅ 认证成功后自动返回 CLI
- ✅ Token 安全存储在本地
- ✅ 可以查看认证状态

---

### 📁 2. 文件同步操作

#### 场景 A：拉取单个文件
```bash
# 准备：需要一个已存在的项目 ID
npx uspark pull README.md --project-id <your-project-id>

# 拉取并保存到不同位置
npx uspark pull src/index.ts --project-id <your-project-id> --output ./local-copy.ts
```

**预期结果**：
- ✅ 文件成功下载到本地
- ✅ 保持原始内容和格式
- ✅ 支持自定义输出路径

#### 场景 B：推送文件到云端
```bash
# 创建测试文件
echo "# Test Document" > test.md

# 推送到项目
npx uspark push test.md --project-id <your-project-id>

# 推送本地文件到云端不同路径
npx uspark push docs/readme.md --project-id <your-project-id> --source ./test.md
```

**预期结果**：
- ✅ 文件成功上传到云端
- ✅ 支持重命名上传
- ✅ 实时同步到 web 界面

---

### 🌐 3. Web 界面功能

#### 场景 A：项目列表管理
1. 访问 https://app.uspark.com
2. 登录账号
3. 查看项目列表页面

**可以体验**：
- ✅ 查看所有项目
- ✅ 创建新项目
- ✅ 点击项目进入文件浏览器

#### 场景 B：文件浏览器操作
1. 进入项目详情页
2. 浏览文件树结构
3. 点击文件查看内容

**可以体验**：
- ✅ 展开/折叠文件夹
- ✅ 查看文件内容
- ✅ 实时同步（当通过 CLI 推送文件时，web 界面实时更新）

---

### 🔗 4. 文档分享功能

#### 场景：创建公开分享链接
1. 在项目文件浏览器中选择一个文件
2. 点击"分享"按钮
3. 生成公开访问链接
4. 在无需登录的浏览器中访问链接

**可以体验**：
- ✅ 生成唯一的分享链接
- ✅ 无需登录即可查看
- ✅ 只读访问权限
- ✅ 分享整个项目或单个文件

---

### 🔑 5. CLI Token 管理

#### 场景：管理 CLI 访问令牌
1. 访问 https://app.uspark.com/settings
2. 进入 CLI Tokens 页面
3. 生成新的 CLI token

**可以体验**：
- ✅ 生成新的访问令牌
- ✅ 查看现有令牌列表
- ✅ 撤销旧令牌
- ✅ 使用环境变量认证：
  ```bash
  export USPARK_TOKEN=<your-token>
  npx uspark pull README.md --project-id <project-id>
  ```

---

### 🚀 6. 端到端工作流

#### 完整场景：从创建到分享
```bash
# 1. 认证
npx uspark auth login

# 2. 创建本地文件
mkdir my-docs
cd my-docs
echo "# My Project" > README.md
echo "console.log('Hello Uspark');" > index.js

# 3. 推送到云端
npx uspark push README.md --project-id <project-id>
npx uspark push index.js --project-id <project-id>

# 4. 在 Web 查看
# 打开 https://app.uspark.com/projects/<project-id>
# 可以看到刚上传的文件

# 5. 修改文件
echo "## Updated" >> README.md
npx uspark push README.md --project-id <project-id>

# 6. 拉取最新版本
rm README.md
npx uspark pull README.md --project-id <project-id>
cat README.md  # 应该看到更新的内容

# 7. 创建分享链接
# 在 Web 界面点击分享，获得公开链接
```

---

### 🧪 测试环境准备

#### 必需条件：
1. Node.js 18+ 已安装
2. pnpm 包管理器已安装
3. 有效的 Uspark 账号
4. 至少一个已创建的项目

#### 快速开始命令：
```bash
# 克隆仓库
git clone https://github.com/uspark-hq/uspark.git
cd uspark/turbo

# 安装依赖
pnpm install

# 构建 CLI
pnpm build

# 开始测试
npx uspark --help
```

---

### 📝 反馈收集点

在测试过程中，请关注以下体验：

1. **认证流程**是否流畅？
2. **文件同步**速度如何？
3. **Web 界面**响应速度？
4. **错误提示**是否清晰？
5. **分享功能**是否符合预期？

每个场景都可以独立测试，建议按顺序体验以获得完整的产品感受。