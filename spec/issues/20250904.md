# 2025-09-04 开发任务清单

## 概述

基于 MVP 规格文档，制定 8 个可并行开发的独立任务，避免代码冲突，让团队成员能够高效协作推进项目。

## 任务列表

### 1. CLI - 实现 uspark push 命令

**负责模块**: `turbo/apps/cli`

**任务描述**:
- 实现本地文件上传到 YJS 存储的功能
- 支持单个文件推送：`uspark push <file-path> --project-id <id>`
- 支持批量推送：`uspark push --all --project-id <id>`
- 使用环境变量 `USPARK_TOKEN` 进行认证

**验收标准**:
- [ ] 单文件推送功能正常工作
- [ ] --all 参数能批量推送所有修改的文件
- [ ] 正确处理文件不存在和权限错误
- [ ] 推送成功后显示上传的文件列表

**相关文档**: `spec/issues/mvp.md` (Story 1)

---

### 2. Web UI - 创建 CLI Token 管理页面

**负责模块**: `turbo/apps/web/app/settings/tokens`

**任务描述**:
- 创建 token 生成和管理界面
- 实现生成新 token 的功能
- 显示 token 一次后不再显示（安全考虑）
- 提供复制 token 到剪贴板的功能

**验收标准**:
- [ ] 页面路由 `/settings/tokens` 可访问
- [ ] 能够生成新的 CLI token
- [ ] Token 只显示一次，刷新后不再显示
- [ ] 复制按钮正常工作并有反馈提示

**相关文档**: `spec/issues/cli-auth.md`

---

### 3. Backend - 项目管理 APIs ✅

**负责模块**: `turbo/apps/web/app/api/projects`

**任务描述**:
- 实现项目列表获取：`GET /api/projects`
- 实现创建新项目：`POST /api/projects`
- 复用现有的 YJS 同步端点进行文件数据管理
- 客户端解析 YJS snapshot 获取文件结构和内容

**验收标准**:
- [x] 列表 API 返回用户的所有项目
- [x] 创建项目 API 正确初始化 YJS 文档
- [x] 客户端能够从 YJS snapshot 解析文件结构
- [x] 通过现有 YJS 同步机制管理项目数据

**完成情况**:
- ✅ PR #99 已合并：`feat: implement project management apis with client-side file parsing`
- ✅ 实现了 GET /api/projects（列出用户项目）和 POST /api/projects（创建新项目）
- ✅ 添加了 @uspark/core 中的 API contracts 用于类型安全验证
- ✅ 包含 10 个完整的测试用例，覆盖所有功能和错误场景
- ✅ 使用客户端 YJS snapshot 解析方式，避免了不必要的文件 API 端点
- ✅ 所有代码质量检查通过（lint, type check, tests）

**相关文档**: `spec/issues/web-ui.md`

---

### 4. Frontend - 文件浏览器组件

**负责模块**: `turbo/apps/web/components/file-explorer`

**任务描述**:
- 开发树形文件浏览器 React 组件
- 支持文件夹展开/折叠
- 显示文件图标（区分文件类型）
- 点击文件触发选择事件

**验收标准**:
- [ ] 树形结构正确渲染
- [ ] 文件夹可以展开和折叠
- [ ] 文件图标根据扩展名显示
- [ ] 点击事件正确传递文件路径

**相关文档**: `spec/issues/web-ui.md`

---

### 5. Backend - 文档分享 APIs

**负责模块**: `turbo/apps/web/app/api/share`

**任务描述**:
- 生成分享链接：`POST /api/share`
- 获取分享内容：`GET /api/share/:token`
- 列出用户分享：`GET /api/share`
- 撤销分享链接：`DELETE /api/share/:id`

**验收标准**:
- [ ] 生成的 token 是加密安全的随机字符串
- [ ] 公开访问端点不需要认证
- [ ] 正确记录访问次数和时间
- [ ] 删除操作正确清理数据

**相关文档**: `spec/issues/document-sharing.md`

---

### 6. CLI - uspark watch-claude 命令 ✅

**负责模块**: `turbo/apps/cli/src/commands`

**任务描述**:
- 实现监听 Claude JSON 输出流的功能
- 检测文件写入事件并触发实时同步
- 保持输出透明传递（不影响原始输出）
- 后台执行 `uspark push` 同步文件

**验收标准**:
- [x] 正确解析 Claude 的 JSON 格式输出
- [x] 检测到文件写入立即触发同步
- [x] 原始输出完整传递不受影响
- [x] 错误处理不中断主流程

**完成情况**:
- ✅ PR #100 已合并：`feat(cli): implement uspark watch-claude command for real-time sync`
- ✅ 实现了完整的 watch-claude 命令，支持实时监控和同步
- ✅ 包含测试用例覆盖各种场景
- ✅ 与 Claude Code 输出格式完美集成

**相关文档**: `spec/issues/e2b-runtime-container.md`

---

### 7. Frontend - 公开文档查看页面

**负责模块**: `turbo/apps/web/app/share/[token]`

**任务描述**:
- 创建无需认证的公开查看页面
- 实现只读文档查看器（支持语法高亮）
- 项目分享时显示文件树
- 响应式设计支持移动端

**验收标准**:
- [ ] 路由 `/share/:token` 可公开访问
- [ ] 文档内容正确显示并有语法高亮
- [ ] 项目分享显示完整文件树
- [ ] 移动端布局正常显示

**相关文档**: `spec/issues/document-sharing.md`

---

### 8. Database - 数据库表结构设置 ✅

**负责模块**: `turbo/apps/web/src/db/migrations`

**任务描述**:
- 创建 `agent_sessions` 表存储 Agent 执行会话（原 claude_tasks）
- 创建 `share_links` 表存储分享链接
- 设置必要的索引优化查询性能
- 添加外键约束确保数据完整性

**验收标准**:
- [x] 迁移脚本可以正常执行
- [x] 表结构符合规格文档定义
- [x] 索引正确创建（token, project_id 等）
- [x] 外键约束正确设置

**完成情况**: 
- ✅ PR #102 已合并：`feat: add agent_sessions and share_links database tables`
- ✅ 创建了 `0004_agent_sessions_share_links.sql` 迁移文件
- ✅ 添加了 Drizzle schema 定义：`agent-sessions.ts`, `share-links.ts`
- ✅ 包含完整的外键约束和性能优化索引

**相关文档**: 
- `spec/issues/web-ui.md` (claude_tasks 表)
- `spec/issues/document-sharing.md` (share_links 表)

---

## 并行开发策略

这 8 个任务分布在不同的代码区域，可以实现真正的并行开发：

1. **CLI 包任务** (任务 1, 6): 两个不同的命令，互不干扰
2. **Web 前端任务** (任务 2, 4, 7): 三个独立的页面/组件
3. **API 后端任务** (任务 3, 5): 两组不同的 API 端点
4. **数据库任务** (任务 8): 独立的数据库层面工作

## 注意事项

- 每个任务开始前先从 main 分支创建独立的功能分支
- 遵循项目的 commit message 规范（conventional commits）
- 完成后运行 lint 和 type check 确保代码质量
- 及时更新任务状态，方便团队了解进度

## 依赖关系

大部分任务相互独立，但存在以下软依赖：
- 任务 2 (Token 管理页面) 依赖已有的 token 生成 API（已完成）
- 任务 7 (公开查看页) 最好在任务 5 (分享 API) 之后测试
- 其他任务完全独立，可立即开始

## 预期成果

完成这 8 个任务后，将实现 MVP 的核心功能：
- ✅ 完整的 CLI 同步功能（push/pull）
- 🔄 Web UI 项目管理和文件浏览（项目管理 API 已完成）
- ✅ 文档分享功能
- ✅ Claude Code 集成准备
- ✅ 必要的数据库基础设施