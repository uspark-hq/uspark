# 2025-09-05 开发任务清单

## 概述

基于 MVP 进度和技术债务追踪，制定 8 个可并行开发的小粒度任务。每个任务独立可完成，互不阻塞。

## 任务列表

### 1. 修复项目 API 硬编码用户认证 🔐

**负责模块**: `turbo/apps/web/app/api/projects`

**任务描述**:
- 替换 `route.ts` 中硬编码的 `userId = "test-user"`
- 集成 Clerk 认证获取真实用户 ID
- 确保所有项目操作使用实际登录用户
- 更新相关测试用例

**验收标准**:
- [ ] GET /api/projects 返回当前用户的项目
- [ ] POST /api/projects 创建项目归属于当前用户
- [ ] 非认证请求返回 401 错误
- [ ] 测试用例使用模拟认证

**相关文档**: `spec/issues/20250904.md` (严重问题 #1)

---

### 2. 修复 CLI 认证硬编码延迟 ⏱️

**负责模块**: `turbo/apps/cli/src/auth.ts`

**任务描述**:
- 修复第 86 行的硬编码 5 秒延迟
- 使用服务器返回的 `deviceAuth.interval * 1000`
- 引入 `signal-timers` 包的 `delay()` 函数
- 遵循 YAGNI 原则，移除不必要的等待

**验收标准**:
- [ ] 使用动态轮询间隔而非硬编码
- [ ] 引入并使用 `delay()` 函数
- [ ] 认证流程按服务器指定间隔轮询
- [ ] 代码通过 lint 和类型检查

**相关文档**: 
- `spec/issues/20250904.md` (严重问题 #2)
- `spec/tech-debt.md` (Promise-based Delays)

---

### 3. Review 并合并 PR #113 (CLI push 命令) 📤

**负责模块**: PR #113 - `feat(cli): enhance push command with batch upload support`

**任务描述**:
- Review PR #113 的代码实现
- 验证单文件和批量上传功能
- 测试 blob-token API 端点
- 确认所有测试通过后合并

**验收标准**:
- [ ] 代码 review 完成，无阻塞问题
- [ ] 本地测试 push 单文件功能正常
- [ ] 本地测试 push --all 批量功能正常
- [ ] CI/CD 所有检查通过
- [ ] PR 成功合并到 main

**PR 包含功能**:
- ✅ 单文件 push: `uspark push <file> --project-id <id>`
- ✅ 批量 push: `uspark push --all --project-id <id>`
- ✅ Blob STS token API 实现
- ✅ 7 个测试用例覆盖

**相关文档**: 
- `spec/issues/mvp.md` (Phase 2)
- `spec/issues/yjs.md` (CLI Commands)
- PR #113

---

### 4. 实现 CLI pull --all 批量拉取 🔽

**负责模块**: `turbo/apps/cli/src/project-sync.ts`

**任务描述**:
- 实现 `uspark pull --all --project-id <id>` 命令
- 从 YJS 文档获取所有文件列表
- 批量下载到本地，保持目录结构
- 添加进度显示和错误处理

**验收标准**:
- [ ] 命令正确拉取整个项目
- [ ] 保持原始目录结构
- [ ] 显示下载进度（文件数和大小）
- [ ] 跳过已存在且未修改的文件
- [ ] 包含测试用例

**实现思路**:
- 复用现有 `pullFile` 方法
- 从 YJS snapshot 解析文件列表
- 并行下载提升性能
- 对比文件 hash 避免重复下载

**相关文档**: 
- `spec/issues/mvp.md` (Phase 2 - Developer Tools)
- `spec/issues/yjs.md` (CLI Commands)

---

### 5. 替换 process.env 为 env() 函数 🌍

**负责模块**: `turbo/apps/web`

**任务描述**:
- 扫描 web 应用中所有 `process.env` 使用
- 替换为 `env()` 函数调用
- 排除 Node.js 配置文件（如 drizzle.config.ts）
- 确保环境变量类型安全

**验收标准**:
- [ ] Web 应用代码不直接使用 process.env
- [ ] 配置文件保持 process.env 使用
- [ ] env() 函数提供类型安全
- [ ] 应用正常启动和运行

**相关文档**: `spec/tech-debt.md` (Environment Variable Usage)

---

### 6. 优化 claude-watch 移除 spawn 🔧

**负责模块**: `turbo/apps/cli/src/commands/watch-claude.ts`

**任务描述**:
- 重构 watch-claude 命令，移除不必要的 spawn
- 直接调用相应方法而非创建子进程
- 保持原有功能不变
- 提升性能和可维护性

**验收标准**:
- [ ] 移除所有不必要的 spawn 调用
- [ ] 功能保持不变
- [ ] 性能有所提升
- [ ] 代码更易于测试

**相关文档**: `spec/tech-debt.md` (CLI Script Optimization)

---

### 7. 重构 config 模块避免 vi.mock 🧪

**负责模块**: `turbo/apps/cli/src/config` 及相关测试

**任务描述**:
- 创建 `overrideConfig` 对象机制
- 添加 `setOverrideConfig` 导出方法
- 更新测试文件，移除 vi.mock 使用
- 保持测试覆盖率不变

**验收标准**:
- [ ] config 模块支持运行时覆盖
- [ ] 测试不再使用 vi.mock
- [ ] 所有现有测试通过
- [ ] 代码更易于测试和维护

**相关文档**: `spec/tech-debt.md` (Mock Usage in Tests)

---

### 8. 审计并移除重复的 GitHub Actions 工具 🎯 ✅

**负责模块**: `.github/workflows` 和 `Dockerfile`

**任务描述**:
- 审计 GitHub Actions 中安装的所有工具
- 对比 Dockerfile 中已安装的工具
- 移除 Actions 中的重复安装
- 确认 Neon CLI 等工具不再手动安装

**验收标准**:
- [x] 列出所有重复安装的工具
- [x] 移除 Actions 中的重复安装命令
- [x] CI/CD 流程正常运行
- [x] 构建时间有所减少

**完成状态**: 
- PR #136: https://github.com/uspark-hq/uspark/pull/136
- 移除了 e2e-test 中重复的 Node.js 和 pnpm 安装
- 删除了不再使用的 `.github/actions/init/` 目录

**相关文档**: `spec/tech-debt.md` (GitHub Actions Tool Installation)

---

## 并行开发策略

这 8 个任务分布在不同的代码区域，可以完全并行开发：

1. **API 修复** (任务 1): 后端 API 改进
2. **CLI 功能** (任务 2, 3, 4, 6): CLI 相关功能和优化
3. **代码质量** (任务 5, 7): 代码重构和改进
4. **DevOps** (任务 8): CI/CD 优化

## 注意事项

- 每个任务从 main 分支创建独立功能分支
- 遵循 conventional commits 规范
- 完成后运行 `cd turbo && pnpm turbo run lint && pnpm check-types`
- 及时更新任务状态

## 优先级建议

**高优先级** (阻塞其他功能):
- 任务 1: 修复用户认证（影响所有用户功能）
- 任务 3: Review 并合并 PR #113（push 功能 + Blob Token）
- 任务 4: 实现 pull --all 命令（批量拉取）

**中优先级** (改善体验):
- 任务 2: 修复认证延迟
- 任务 5: 环境变量规范化
- 任务 6: CLI 性能优化

**低优先级** (技术债务):
- 任务 7: 测试重构
- 任务 8: CI/CD 优化