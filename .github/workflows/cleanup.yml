name: Cleanup Resources

on:
  pull_request:
    types: [closed]

jobs:
  cleanup-database:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/uspark-hq/uspark-toolchain:c2b456c
    steps:
      - uses: actions/checkout@v4

      - name: Delete Neon Branch
        uses: ./.github/actions/neon-branch
        with:
          neon-api-key: ${{ secrets.NEON_API_KEY }}
          neon-project-id: ${{ vars.NEON_PROJECT_ID }}
          branch-name: "${{ github.event.pull_request.head.ref }}"
          action: "cleanup"

  cleanup-deployments:
    runs-on: ubuntu-latest
    permissions:
      deployments: write
    steps:
      - name: Delete PR Deployments
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const sha = context.payload.pull_request.head.sha;

            console.log(`Cleaning up deployments for branch: ${branchName}, sha: ${sha}`);

            // Get all deployments and filter by branch name
            const allDeployments = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // Filter deployments that belong to this branch
            const branchDeployments = allDeployments.data.filter(deployment => {
              // Match by ref or environment name containing branch
              return deployment.ref === branchName ||
                     deployment.ref === `refs/heads/${branchName}` ||
                     deployment.ref === sha ||
                     deployment.environment?.includes(`preview/${branchName}`);
            });

            console.log(`Found ${branchDeployments.length} deployments to delete`);

            // Delete each deployment (must mark as inactive first)
            for (const deployment of branchDeployments) {
              console.log(`Deleting deployment ${deployment.id} (${deployment.environment})`);

              // Step 1: Mark as inactive
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.id,
                state: 'inactive',
                description: 'PR closed - cleaning up'
              });

              // Step 2: Delete the deployment
              try {
                await github.rest.repos.deleteDeployment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.id
                });
                console.log(`Successfully deleted deployment ${deployment.id}`);
              } catch (error) {
                console.error(`Failed to delete deployment ${deployment.id}: ${error.message}`);
              }
            }